document.addEventListener("DOMContentLoaded",()=>{let e="http://localhost:3000/api",t=document.getElementById("modal"),r=document.getElementById("modalTitle"),a=document.getElementById("modalBody"),o=document.getElementById("modalClose"),n=document.querySelector(".modal-content"),i=document.getElementById("content-area"),l=document.getElementById("themeToggle");function s(e,o){r.textContent=e,a.innerHTML=o,t.classList.remove("hidden"),n.classList.add("start-animation")}function d(){n.classList.remove("start-animation"),t.classList.add("hidden")}function c(e,t=!1){if(!e)return"N/A";let r=new Date(e),a=6e4*r.getTimezoneOffset(),o=new Date(r.getTime()+a),n={day:"2-digit",month:"2-digit",year:"numeric"};return t&&(n.hour="2-digit",n.minute="2-digit"),o.toLocaleString("es-ES",n)}async function u(){try{let[t,r]=await Promise.all([fetch(`${e}/productos`),fetch(`${e}/movimientos`)]);if(!t.ok||!r.ok)throw Error("Error al cargar datos del dashboard");let a=await t.json(),o=await r.json(),n=new Date,i=a.filter(e=>e.cantidad<10).length,l=a.filter(e=>{if(!e.vencimiento)return!1;let t=new Date(e.vencimiento).getTime()-n.getTime(),r=Math.ceil(t/864e5);return r>0&&r<=30}).length;document.getElementById("totalProductos").textContent=a.length,document.getElementById("stockCritico").textContent=i,document.getElementById("proximosAVencer").textContent=l;let s=document.getElementById("ultimosMovimientos");if(!o||0===o.length){s.innerHTML="<p>No hay movimientos recientes.</p>";return}let d=document.createElement("ul");d.className="movimientos-lista",o.forEach(e=>{let t=document.createElement("li"),r="Entrada"===e.Tipo?"entrada":"salida";t.innerHTML=`
              <span class="movimiento-tipo ${r}">${e.Tipo}</span>
              <span class="movimiento-cantidad">${e.Cantidad} x</span>
              <span class="movimiento-nombre">${e.ProductoNombre}</span>
              <span class="movimiento-fecha">${c(e.Fecha,!0)}</span>
          `,d.appendChild(t)}),s.innerHTML="",s.appendChild(d)}catch(e){console.error("Error actualizando dashboard:",e)}}function m(t,r){fetch(t).then(e=>e.text()).then(t=>{switch(i.innerHTML=t,document.getElementById("header-title").textContent=r.charAt(0).toUpperCase()+r.slice(1),r){case"inventario":!function(){let t=document.getElementById("tablaProductos");function r(e){if(!e)return"";let t=new Date(e);return t.setMinutes(t.getMinutes()+t.getTimezoneOffset()),t.toISOString().split("T")[0]}async function o(){try{let r=await fetch(`${e}/productos`);if(!r.ok)throw Error(`HTTP error! status: ${r.status}`);let a=await r.json();!function(e){if(t.innerHTML="",0===e.length){t.innerHTML='<tr><td colspan="7">No hay productos en el inventario.</td></tr>';return}e.forEach(e=>{let r=document.createElement("tr");r.dataset.id=e.ProductoID,r.innerHTML=`
          <td>${e.nombre}</td>
          <td>${e.categoria}</td>
          <td>${e.cantidad}</td>
          <td>${e.ubicacion||"N/A"}</td>
          <td>${c(e.ingreso)}</td>
          <td>${c(e.vencimiento)}</td>
          <td>
            <button class="btn-editar" aria-label="Editar ${e.nombre}"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn-eliminar" aria-label="Eliminar ${e.nombre}"><i class="fas fa-trash-alt"></i> Eliminar</button>
          </td>
        `,t.appendChild(r)})}(a)}catch(e){console.error("Error al cargar los productos:",e),t.innerHTML='<tr><td colspan="7">Error al cargar los productos.</td></tr>'}}async function n(t){t.preventDefault();let r=Object.fromEntries(new FormData(t.target).entries());try{let t=await fetch(`${e}/productos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),a=await t.json();if(!t.ok)throw Error(a.error||"Error en el servidor");alert(a.message),d(),o(),u()}catch(e){console.error("Error al agregar el producto:",e),alert(`Error al agregar el producto: ${e.message}`)}}async function i(t,r){t.preventDefault();let a=Object.fromEntries(new FormData(t.target).entries());try{let t=await fetch(`${e}/productos/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),n=await t.json();if(!t.ok)throw Error(n.error||"Error en el servidor");alert(n.message),d(),o(),u()}catch(e){console.error("Error al actualizar el producto:",e),alert(`Error al actualizar el producto: ${e.message}`)}}async function l(t){try{let[o,n]=await Promise.all([fetch(`${e}/productos/${t}`),fetch("agregar-producto.html")]);if(!o.ok)throw Error("Error al cargar los datos del producto.");if(!n.ok)throw Error("Error al cargar el formulario.");let l=await o.json(),d=await n.text();s("Editar Producto",d);let c=a.querySelector("form");c.querySelector("#nombre").value=l.nombre,c.querySelector("#categoria").value=l.categoria,c.querySelector("#cantidad").value=l.cantidad,c.querySelector("#ubicacion").value=l.ubicacion,c.querySelector("#ingreso").value=r(l.ingreso),c.querySelector("#vencimiento").value=r(l.vencimiento),c.querySelector("button[type='submit']").textContent="Actualizar Producto",c.addEventListener("submit",e=>i(e,t))}catch(e){console.error("Error en handleEditarProducto:",e),alert(e.message)}}async function m(t){if(confirm("¿Estás seguro de que quieres eliminar este producto?"))try{let r=await fetch(`${e}/productos/${t}`,{method:"DELETE"}),a=await r.json();if(!r.ok)throw Error(a.error||"Error en el servidor");alert(a.message),o(),u()}catch(e){console.error("Error al eliminar el producto:",e),alert(`Error al eliminar el producto: ${e.message}`)}}document.getElementById("btnAgregar").addEventListener("click",async()=>{try{let e=await fetch("agregar-producto.html"),t=await e.text();s("Agregar Producto",t),a.querySelector("form").addEventListener("submit",n)}catch(e){console.error("Error al cargar el formulario:",e),alert("Error al cargar el formulario de agregar producto.")}}),t.addEventListener("click",function(e){let t=e.target.closest("button");if(!t)return;let r=t.closest("tr").dataset.id;t.classList.contains("btn-editar")&&l(r),t.classList.contains("btn-eliminar")&&m(r)}),document.querySelector(".search-bar").addEventListener("input",e=>{let r=e.target.value.toLowerCase();t.querySelectorAll("tr").forEach(e=>{e.querySelector("td").textContent.toLowerCase().includes(r)?e.style.display="":e.style.display="none"})}),o(),u()}();break;case"usuarios":!function(){let t=document.getElementById("formUsuarios"),r=document.getElementById("tablaUsuarios");async function o(){try{let t=await fetch(`${e}/usuarios`);if(!t.ok)throw Error("Error al cargar usuarios");let a=await t.json();!function(e){if(r.innerHTML="",0===e.length){r.innerHTML='<tr><td colspan="5">No hay usuarios registrados.</td></tr>';return}e.forEach(e=>{let t=document.createElement("tr");t.dataset.id=e.UsuarioID,t.innerHTML=`
                <td>${e.UsuarioID}</td>
                <td>${e.nombre}</td>
                <td>${e.email}</td>
                <td>${e.Rol}</td>
                <td>
                    <button class="btn-editar"><i class="fas fa-edit"></i> Editar</button>
                    <button class="btn-eliminar"><i class="fas fa-trash-alt"></i> Eliminar</button>
                </td>
            `,r.appendChild(t)})}(a)}catch(e){console.error(e),r.innerHTML=`<tr><td colspan="5">${e.message}</td></tr>`}}async function n(t,r){t.preventDefault();let a=t.target,n={nombre:a.nombre.value,email:a.email.value,Rol:a.rol.value};a.password.value&&(n.password=a.password.value);try{let t=await fetch(`${e}/usuarios/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),a=await t.json();if(!t.ok)throw Error(a.error||"Error en el servidor");alert(a.message),d(),o()}catch(e){console.error("Error al actualizar el usuario:",e),alert(`Error al actualizar el usuario: ${e.message}`)}}async function i(t){try{let[r,o]=await Promise.all([fetch(`${e}/usuarios/${t}`),fetch("usuarios.html")]);if(!r.ok)throw Error("Error al cargar los datos del usuario.");if(!o.ok)throw Error("Error al cargar el formulario.");let i=await r.json(),l=await o.text(),d=new DOMParser().parseFromString(l,"text/html").querySelector("#formUsuarios");if(!d)throw Error("No se pudo encontrar el formulario en usuarios.html");s("Editar Usuario",d.outerHTML);let c=a.querySelector("form");c.querySelector("#nombre").value=i.nombre,c.querySelector("#email").value=i.email,c.querySelector("#rol").value=i.Rol;let u=c.querySelector("#password");u.placeholder="Dejar en blanco para no cambiar",u.required=!1,c.querySelector("button[type='submit']").textContent="Actualizar Usuario",c.addEventListener("submit",e=>n(e,t))}catch(e){console.error("Error en handleEditarUsuario:",e),alert(e.message)}}async function l(t){if(confirm("¿Estás seguro de que quieres eliminar este usuario?"))try{let r=await fetch(`${e}/usuarios/${t}`,{method:"DELETE"}),a=await r.json();if(!r.ok)throw Error(a.error||"Error en el servidor");alert(a.message),o()}catch(e){console.error("Error al eliminar el usuario:",e),alert(`Error al eliminar el usuario: ${e.message}`)}}r.addEventListener("click",function(e){let t=e.target.closest("button");if(!t)return;let r=t.closest("tr").dataset.id;t.classList.contains("btn-editar")&&i(r),t.classList.contains("btn-eliminar")&&l(r)}),t.addEventListener("submit",async t=>{t.preventDefault();let r=t.target,a={nombre:r.nombre.value,email:r.email.value,password:r.password.value,Rol:r.rol.value};try{let t=await fetch(`${e}/usuarios`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),n=await t.json();if(!t.ok)throw Error(n.error||"Error al crear usuario");alert(n.message),r.reset(),o()}catch(e){alert(e.message)}}),o()}();break;case"entrada":let o,n;o=document.getElementById("formEntrada"),n=document.getElementById("nombreProductoEntrada"),fetch(`${e}/productos`).then(e=>e.json()).then(e=>{e.forEach(e=>{let t=document.createElement("option");t.value=e.ProductoID,t.textContent=e.nombre,n.appendChild(t)})}).catch(e=>{console.error("Error al cargar productos:",e),alert("Error al cargar la lista de productos.")}),o.addEventListener("submit",function(t){t.preventDefault(),fetch(`${e}/entradas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(new FormData(t.target).entries()))}).then(e=>e.json().then(t=>({ok:e.ok,body:t}))).then(({ok:e,body:r})=>{if(!e)throw Error(r.error||"Error en la respuesta del servidor");alert(r.message),t.target.reset(),u()}).catch(e=>{console.error("Error:",e),alert(`Hubo un error al guardar la entrada: ${e.message}`)})});break;case"salida":let l,m;l=document.getElementById("formSalida"),m=document.getElementById("nombreProductoSalida"),fetch(`${e}/productos`).then(e=>e.json()).then(e=>{e.forEach(e=>{let t=document.createElement("option");t.value=e.ProductoID,t.textContent=e.nombre,m.appendChild(t)})}).catch(e=>{console.error("Error al cargar productos:",e),alert("Error al cargar la lista de productos.")}),l.addEventListener("submit",function(t){t.preventDefault(),fetch(`${e}/salidas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(new FormData(t.target).entries()))}).then(e=>e.json().then(t=>({ok:e.ok,body:t}))).then(({ok:e,body:r})=>{if(!e)throw Error(r.error||"Error en la respuesta del servidor");alert(r.message),t.target.reset(),u()}).catch(e=>{console.error("Error:",e),alert(`Hubo un error al registrar la salida: ${e.message}`)})});break;case"reportes":new Promise((e,t)=>{let r=document.createElement("script");r.src="https://cdn.jsdelivr.net/npm/chart.js",r.onload=e,r.onerror=t,document.head.appendChild(r)}).then(()=>{!function(){let t=document.getElementById("formReportes");document.getElementById("reporteContainer");let r=document.getElementById("reporteHeader"),a=document.getElementById("reporteTitulo"),o=document.getElementById("btnImprimir"),n=document.getElementById("reporteContenido"),i=document.getElementById("fechaInicioReporte"),l=document.getElementById("fechaFinReporte"),s=document.getElementById("tipoReporte");function d(e,t){let r=document.getElementById("reporteGrafico").getContext("2d"),a={};switch(window.myChart instanceof Chart&&window.myChart.destroy(),t){case"inventario":a={labels:e.map(e=>e.nombre),datasets:[{label:"Cantidad en Inventario",data:e.map(e=>e.cantidad),backgroundColor:"rgba(54, 162, 235, 0.6)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}]};break;case"entradas":case"salidas":let o=e.reduce((e,t)=>{let r=c(t.Fecha);return e[r]=(e[r]||0)+t.Cantidad,e},{});a={labels:Object.keys(o),datasets:[{label:`Cantidad de ${t}`,data:Object.values(o),backgroundColor:"entradas"===t?"rgba(75, 192, 192, 0.6)":"rgba(255, 99, 132, 0.6)",borderColor:"entradas"===t?"rgba(75, 192, 192, 1)":"rgba(255, 99, 132, 1)",borderWidth:1}]};break;case"vencimientos":a={labels:e.map(e=>e.nombre),datasets:[{label:"Días para Vencer",data:e.map(e=>{let t=new Date;return Math.ceil((new Date(e.vencimiento).getTime()-t.getTime())/864e5)}),backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:1}]}}window.myChart=new Chart(r,{type:"bar",data:a,options:{scales:{y:{beginAtZero:!0}},responsive:!0,maintainAspectRatio:!1}})}s.addEventListener("change",()=>{let e=s.value;"entradas"===e||"salidas"===e?(i.parentElement.style.display="block",l.parentElement.style.display="block"):(i.parentElement.style.display="none",l.parentElement.style.display="none")}),s.dispatchEvent(new Event("change")),o.addEventListener("click",()=>{window.print()}),t.addEventListener("submit",async function(t){t.preventDefault();let o=s.value,u=i.value,m=l.value;n.innerHTML="<p>Generando reporte...</p>",r.style.display="none";try{let t,i;switch(o){case"inventario":t=`${e}/productos`;let l=await fetch(t);if(!l.ok)throw Error("Error al cargar el inventario.");i=await l.json(),function(e){if(r.style.display="flex",a.textContent="Reporte de Inventario Actual",n.innerHTML='<div class="chart-container"><canvas id="reporteGrafico"></canvas></div><div id="tablaReporteContenedor"></div>',0===e.length){n.innerHTML="<p>No hay productos en el inventario.</p>";return}d(e,"inventario");let t=`
            <table class="tabla-reporte">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Categor\xeda</th>
                        <th>Cantidad</th>
                        <th>Ubicaci\xf3n</th>
                        <th>Fecha Ingreso</th>
                    </tr>
                </thead>
                <tbody>
                    ${e.map(e=>`
                        <tr>
                            <td>${e.nombre}</td>
                            <td>${e.categoria}</td>
                            <td>${e.cantidad}</td>
                            <td>${e.ubicacion||"N/A"}</td>
                            <td>${c(e.ingreso)}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>`;document.getElementById("tablaReporteContenedor").innerHTML=t}(i);break;case"entradas":case"salidas":t=`${e}/movimientos?tipo=${o.slice(0,-1)}&inicio=${u}&fin=${m}`;let s=await fetch(t);if(!s.ok)throw Error(`Error al cargar ${o}.`);i=await s.json(),function(e,t){let o=`Reporte de ${t.charAt(0).toUpperCase()+t.slice(1)}`;if(r.style.display="flex",a.textContent=o,n.innerHTML='<div class="chart-container"><canvas id="reporteGrafico"></canvas></div><div id="tablaReporteContenedor"></div>',0===e.length){n.innerHTML=`<p>No hay ${t} en el rango de fechas seleccionado.</p>`;return}d(e,t);let i=`
            <table class="tabla-reporte">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Fecha</th>
                        <th>Usuario</th>
                    </tr>
                </thead>
                <tbody>
                    ${e.map(e=>`
                        <tr>
                            <td>${e.ProductoNombre}</td>
                            <td>${e.Cantidad}</td>
                            <td>${c(e.Fecha,!0)}</td>
                            <td>${e.UsuarioNombre||"N/A"}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>`;document.getElementById("tablaReporteContenedor").innerHTML=i}(i,o);break;case"vencimientos":t=`${e}/productos/vencimiento`;let h=await fetch(t);if(!h.ok)throw Error("Error al cargar productos por vencer.");i=await h.json(),function(e){if(r.style.display="flex",a.textContent="Reporte de Productos Próximos a Vencer",n.innerHTML='<div class="chart-container"><canvas id="reporteGrafico"></canvas></div><div id="tablaReporteContenedor"></div>',0===e.length){n.innerHTML="<p>No hay productos próximos a vencer.</p>";return}d(e,"vencimientos");let t=`
            <table class="tabla-reporte">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Categor\xeda</th>
                        <th>Cantidad</th>
                        <th>Fecha de Vencimiento</th>
                    </tr>
                </thead>
                <tbody>
                    ${e.map(e=>`
                        <tr>
                            <td>${e.nombre}</td>
                            <td>${e.categoria}</td>
                            <td>${e.cantidad}</td>
                            <td>${c(e.vencimiento)}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>`;document.getElementById("tablaReporteContenedor").innerHTML=t}(i)}}catch(e){n.innerHTML=`<p class="error">Error: ${e.message}</p>`,console.error("Error al generar reporte:",e)}})}()}).catch(e=>{console.error("Error loading Chart.js",e),i.innerHTML="<p>Error al cargar la librería de gráficos.</p>"})}}).catch(e=>{console.error("Error al cargar la sección:",e),i.innerHTML="<p>Error al cargar la sección.</p>"})}"dark"===localStorage.getItem("theme")&&document.body.classList.add("dark"),l.addEventListener("click",()=>{document.body.classList.toggle("dark");let e=document.body.classList.contains("dark");localStorage.setItem("theme",e?"dark":"light")}),o.addEventListener("click",d),window.addEventListener("click",e=>{e.target===t&&d()}),document.querySelector("aside.sidebar nav ul").addEventListener("click",e=>{let t=e.target.closest("a");if(t){e.preventDefault();let r=t.dataset.section;document.querySelectorAll("aside.sidebar nav ul li").forEach(e=>e.classList.remove("active")),t.parentElement.classList.add("active"),m({inventario:"inventario.html",entrada:"entrada.html",salida:"salida.html",reportes:"reportes.html",usuarios:"usuarios.html",configuracion:"configuracion.html"}[r]||"inventario.html",r)}}),m("inventario.html","inventario")});
//# sourceMappingURL=web-application-app.e3aaaa9b.js.map
